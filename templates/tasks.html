{% extends "base.html" %}
{% block content %}


<h4 class="mb-3">المهام الوظيفية الحالية</h4>

<form method="post" class="mb-3" style="display:flex; gap:10px; align-items:center;">
  <input type="text" name="title" placeholder="أضف مهمة يدوية" required style="flex:1; padding:10px;">
  <input type="date" name="due_date" style="padding:10px;">
  <button type="submit" style="padding:10px 16px;">حفظ</button>
</form>
<h5 class="mt-3"></h5>

<table class="table table-bordered text-center align-middle">
  <thead class="table-dark">

    <tr>
      <th>المهمة</th>
      <th>التاريخ</th>
      <th>إجراء</th>
    </tr>
  </thead>
  <tbody>
    {% for t in tasks %}
    <tr>
      <td>{{ t["title"] }}</td>
      <td>{{ t["due_date"] or "-" }}</td>
      <td>
        <form method="post" action="{{ url_for('task_delete', tid=t['id']) }}"
              onsubmit="return confirm('حذف المهمة؟');" style="display:inline;">
          <button type="submit" class="btn btn-danger btn-sm">حذف</button>
        </form>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

{% if not tasks %}
  <p class="text-muted">لا توجد مهام يدوية.</p>
{% endif %}

{% if session.perms and session.perms.get('financial_commitments') %}
  <hr class="my-4">

  <h5 class="mb-3">الالتزامات المالية (تلقائية)</h5>

  <div class="table-responsive">
    <table class="table table-striped table-hover align-middle">
      <thead>
        <tr>
          <th>جهة الالتزام</th>
          <th style="width:220px;">المبلغ</th>
          <th style="width:220px;">تاريخ الإضافة</th>
        </tr>
      </thead>
      <tbody>
        {% if commitments|length == 0 %}
          <tr>
            <td colspan="3" class="text-center text-muted py-3">لا توجد التزامات مالية</td>
          </tr>
        {% endif %}

        {% for c in commitments %}
        <tr>
          <td class="fw-semibold">{{ c.party }}</td>
<td>
  <div class="d-inline-flex align-items-center gap-1">
    <span class="fw-semibold">{{ '%.2f'|format(c.amount or 0) }}</span>
    <span class="riyal-icon">
      <img src="{{ url_for('static', filename='img/riyal.png') }}" alt="SAR">
    </span>
  </div>
</td>


          <td class="text-muted small">{{ c.created_at }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% endif %}

<hr>


<table class="table table-bordered text-center align-middle">
  <thead class="table-dark">

    <tr>
      <th>الموقع</th>
      <th>المهمة</th>
      <th>الرقم</th>
      <th>تاريخ الانتهاء</th>
      <th>المتبقي (يوم)</th>
    </tr>
  </thead>
  <tbody>
    {% for r in rows %}
    <tr class="{{ r.color }}">
      <td>{{ r.source }}</td>
      <td>{{ r.name }}</td>
      <td>{{ r.number or "-" }}</td>
      <td>{{ r.expiry or "-" }}</td>
      <td>{{ r.days_left }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>
                                                                                                      
{% if not rows %}
<p class="text-muted">لا توجد مهام حالية.</p>
{% endif %}
<a href="/connect-google">ربط Google Sheets</a>
<div style="display:flex; gap:10px; margin-bottom:12px;">
  <a href="/connect-google" class="btn btn-primary">ربط Google</a>

  <form method="post" action="/export-sheets" style="margin:0;">
    <button type="submit" class="btn btn-success">تصدير إلى Google Sheets</button>
  </form>
</div>

{% endblock %}
