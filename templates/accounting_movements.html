{% extends "base.html" %}
{% block content %}

<style>
  /* Mobile-first adjustments for this page only */
  .movements-actions a { white-space: nowrap; }

  /* Keep cards clean */
  .mv-card{
    border: 1px solid rgba(0,0,0,.08);
    border-radius: 14px;
    padding: 14px;
    background: rgba(255,255,255,.75);
  }
  .mv-kv{
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px 12px;
    margin-top: 10px;
  }
  .mv-kv .k{ font-size: 12px; color: #6c757d; }
  .mv-kv .v{ font-size: 15px; font-weight: 700; color: #111; }

  /* Totals grid on mobile */
  .totals-grid{
    display: grid;
    grid-template-columns: repeat(3, minmax(0,1fr));
    gap: 12px;
  }
  @media (max-width: 992px){
    .totals-grid{ grid-template-columns: repeat(2, minmax(0,1fr)); }
  }
  @media (max-width: 576px){
    .totals-grid{ grid-template-columns: 1fr; }
  }

  /* Switch table/cards */
  .desktop-only{ display: block; }
  .mobile-only{ display: none; }

  @media (max-width: 767.98px){
    .desktop-only{ display: none; }
    .mobile-only{ display: block; }
  }
</style>

<div class="container" style="max-width: 1200px;">
  <div class="card shadow-sm">
    <div class="card-body p-4">

      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
        <div>
          <h3 class="mb-1">استعلام حركات المحاسبة اليومية — {{ kind }}</h3>
        </div>

        <div class="d-flex gap-2 flex-wrap movements-actions">
          <a class="btn btn-outline-secondary" href="{{ url_for('accounting_es', kind=kind) }}">رجوع</a>
          <a class="btn btn-outline-primary" href="{{ url_for('accounting_daily', kind=kind, date=date_to) }}">فتح يوم</a>
        </div>
      </div>

      <hr>

      <!-- Filters -->
      <form method="get" class="row g-3 align-items-end">
        <div class="col-12 col-md-4">
          <label class="form-label">من تاريخ</label>
          <input type="date" class="form-control" name="from" value="{{ date_from }}">
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label">إلى تاريخ</label>
          <input type="date" class="form-control" name="to" value="{{ date_to }}">
        </div>
        <div class="col-12 col-md-4 d-flex gap-2">
          <button class="btn btn-success flex-grow-1 flex-md-grow-0" type="submit">بحث</button>
          <a class="btn btn-outline-secondary flex-grow-1 flex-md-grow-0"
             href="{{ url_for('accounting_movements', kind=kind, **{'from': date_from, 'to': date_to}) }}">تحديث</a>
        </div>
      </form>

      <!-- Overall Totals -->
      <div class="mt-3 totals-grid">

        <div class="p-3 bg-light rounded totals-card">
          <div class="small text-muted">إجمالي صندوق البداية</div>
          <div class="fs-5 fw-bold">{{ '%.2f'|format(overall.cash_start) }}</div>
        </div>

        <div class="p-3 bg-light rounded totals-card">
          <div class="small text-muted">إجمالي صندوق النهاية</div>
          <div class="fs-5 fw-bold">{{ '%.2f'|format(overall.cash_end) }}</div>
        </div>

        <div class="p-3 bg-light rounded totals-card">
          <div class="small text-muted">إجمالي المدخلات</div>
          <div class="fs-5 fw-bold">{{ '%.2f'|format(overall.inputs) }}</div>
        </div>

        <div class="p-3 bg-light rounded totals-card">
          <div class="small text-muted">إجمالي المصروفات العامة</div>
          <div class="fs-5 fw-bold">{{ '%.2f'|format(overall.general) }}</div>
        </div>

        <div class="p-3 bg-light rounded totals-card">
          <div class="small text-muted">إجمالي المصروفات النثرية</div>
          <div class="fs-5 fw-bold">{{ '%.2f'|format(overall.petty) }}</div>
        </div>

        <div class="p-3 bg-light rounded totals-card">
          <div class="small text-muted">إجمالي المصروفات</div>
          <div class="fs-5 fw-bold">{{ '%.2f'|format(overall.expenses) }}</div>
        </div>

        <div class="p-3 bg-light rounded totals-card">
          <div class="small text-muted">الإجمالي الكلي في انجاز</div>
          <div class="fs-5 fw-bold">{{ '%.2f'|format(overall.total_in_enjaz) }}</div>
        </div>

        <div class="p-3 bg-light rounded totals-card">
          <div class="small text-muted">الإجمالي الكلي</div>
          <div class="fs-5 fw-bold">{{ '%.2f'|format(overall.total_overall) }}</div>
        </div>

        <div class="p-3 bg-light rounded totals-card">
          <div class="small text-muted">الخطاء</div>
          <div class="fs-5 fw-bold text-danger">{{ '%.2f'|format(overall.error) }}</div>
        </div>

      </div>

      <!-- Desktop Table -->
      <div class="desktop-only">
        <div class="table-responsive mt-3">
          <table class="table table-striped table-hover align-middle">
            <thead>
              <tr>
                <th>التاريخ</th>
                <th>صندوق البداية</th>
                <th>صندوق النهاية</th>
                <th>مدخلات</th>
                <th>مصروفات عامة</th>
                <th>مصروفات نثرية</th>
                <th>إجمالي المصروفات</th>
                <th>الإجمالي الكلي في انجاز</th>
                <th>الإجمالي الكلي</th>
                <th>الخطاء</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              {% if rows|length == 0 %}
                <tr><td colspan="11" class="text-center text-muted py-4">لا توجد بيانات ضمن هذه المدة</td></tr>
              {% endif %}
              {% for r in rows %}
                {% set expenses = (r.total_general or 0) + (r.total_petty or 0) %}
                {% set total_overall = (r.total_inputs or 0) + expenses + (r.cash_end or 0) - (r.cash_start or 0) %}
                {% set err = total_overall - (r.total_in_enjaz or 0) %}
                <tr>
                  <td class="fw-semibold">{{ r.day_date }}</td>
                  <td>{{ '%.2f'|format(r.cash_start or 0) }}</td>
                  <td>{{ '%.2f'|format(r.cash_end or 0) }}</td>
                  <td>{{ '%.2f'|format(r.total_inputs or 0) }}</td>
                  <td>{{ '%.2f'|format(r.total_general or 0) }}</td>
                  <td>{{ '%.2f'|format(r.total_petty or 0) }}</td>
                  <td>{{ '%.2f'|format(expenses) }}</td>
                  <td>{{ '%.2f'|format(r.total_in_enjaz or 0) }}</td>
                  <td>{{ '%.2f'|format(total_overall) }}</td>
                  <td>{{ '%.2f'|format(err) }}</td>
                  <td>
                    <a class="btn btn-sm btn-outline-primary" href="{{ url_for('accounting_daily', kind=kind, date=r.day_date) }}">فتح</a>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Mobile Cards -->
      <div class="mobile-only mt-3">
        {% if rows|length == 0 %}
          <div class="text-center text-muted py-4">لا توجد بيانات ضمن هذه المدة</div>
        {% endif %}

        <div class="d-grid gap-3">
          {% for r in rows %}
            {% set expenses = (r.total_general or 0) + (r.total_petty or 0) %}
            {% set total_overall = (r.total_inputs or 0) + expenses + (r.cash_end or 0) - (r.cash_start or 0) %}
            {% set err = total_overall - (r.total_in_enjaz or 0) %}

            <div class="mv-card">
              <div class="d-flex justify-content-between align-items-center gap-2 flex-wrap">
                <div class="fw-bold">{{ r.day_date }}</div>
                <a class="btn btn-sm btn-outline-primary" href="{{ url_for('accounting_daily', kind=kind, date=r.day_date) }}">فتح</a>
              </div>

              <div class="mv-kv">
                <div>
                  <div class="k">صندوق البداية</div>
                  <div class="v">{{ '%.2f'|format(r.cash_start or 0) }}</div>
                </div>
                <div>
                  <div class="k">صندوق النهاية</div>
                  <div class="v">{{ '%.2f'|format(r.cash_end or 0) }}</div>
                </div>

                <div>
                  <div class="k">مدخلات</div>
                  <div class="v">{{ '%.2f'|format(r.total_inputs or 0) }}</div>
                </div>
                <div>
                  <div class="k">مصروفات</div>
                  <div class="v">{{ '%.2f'|format(expenses) }}</div>
                </div>

                <div>
                  <div class="k">إجمالي إنجاز</div>
                  <div class="v">{{ '%.2f'|format(r.total_in_enjaz or 0) }}</div>
                </div>
                <div>
                  <div class="k">الإجمالي الكلي</div>
                  <div class="v">{{ '%.2f'|format(total_overall) }}</div>
                </div>

                <div style="grid-column: 1 / -1;">
                  <div class="k">الخطاء</div>
                  <div class="v text-danger">{{ '%.2f'|format(err) }}</div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>

    </div>
  </div>
</div>

{% endblock %}
