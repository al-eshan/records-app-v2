{% extends "base.html" %}
{% block content %}

<div class="container" style="max-width: 1100px;">
  <div class="card shadow-sm">
    <div class="card-body p-4">

      <!-- Header -->
      <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
        <div>
          <h3 class="mb-1">Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ© â€” {{ kind }}</h3>
          <div class="text-muted small">{{ day_date }}</div>
        </div>

        <!-- Desktop: buttons inline | Mobile: full width -->
        <div class="row g-2 w-100 w-md-auto">
          <div class="col-12 col-md-auto">
            <a class="btn btn-secondary btn-sm w-100"
               href="{{ url_for('accounting_es', kind=kind) }}">â†© Ø±Ø¬ÙˆØ¹</a>
          </div>
          <div class="col-12 col-md-auto">
            <a class="btn btn-success btn-sm w-100"
               href="{{ url_for('accounting_movements', kind=kind, **{'from': day_date, 'to': day_date}) }}">
              ğŸ” Ø§Ø³ØªØ¹Ù„Ø§Ù…
            </a>
          </div>
        </div>
      </div>

      <hr>

      <form method="post">

        <!-- Date & Cash & Enjaz -->
        <div class="row g-3 align-items-end">

          <!-- Ø§Ù„ØªØ§Ø±ÙŠØ® -->
          <div class="col-12 col-md-3">
            <label class="form-label">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
            <div class="input-group">
              <input type="date" class="form-control" name="day_date" value="{{ day_date }}" required>
              <button type="submit"
                      name="action"
                      value="open_date"
                      class="btn btn-outline-primary"
                      title="Ø¨Ø­Ø«">
                ğŸ”
              </button>
            </div>
          </div>

          <div class="row g-2 align-items-end">

  <div class="col-6 col-md-3">
    <label class="form-label">ØµÙ†Ø¯ÙˆÙ‚ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ÙŠÙˆÙ…</label>
    <input type="number" step="0.01"
           class="form-control cash-start"
           name="cash_start"
           value="{{ header.cash_start if header else '' }}"
           placeholder="0">
  </div>

  <div class="col-6 col-md-3">
    <label class="form-label">ØµÙ†Ø¯ÙˆÙ‚ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙŠÙˆÙ…</label>
    <input type="number" step="0.01"
           class="form-control cash-end"
           name="cash_end"
           value="{{ header.cash_end if header else '' }}"
           placeholder="0">
  </div>

  <div class="col-6 col-md-3">
    <label class="form-label">Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ø´Ø¨ÙƒØ© mada</label>
    <input type="number" step="0.01"
           class="form-control mada"
           name="mada"
           value="{{ header.mada if header else '' }}"
           placeholder="0">
  </div>

  <div class="col-6 col-md-3">
    <label class="form-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ ÙÙŠ Ø¥Ù†Ø¬Ø§Ø²</label>
    <input type="number" step="0.01"
           class="form-control total-in-enjaz"
           name="total_in_enjaz"
           value="{{ header.total_in_enjaz if header else '' }}"
           placeholder="0">
  </div>

</div>


        </div>

        <!-- Tables -->
        <div class="row g-3 mt-1">

          <!-- Inputs -->
          <div class="col-12 col-lg-4">
            <h5 class="mt-3">Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©</h5>
            <div class="table-responsive">
              <table class="table table-sm align-middle text-center">
                <thead>
                  <tr>
                    <th>Ø§Ù„Ù†ÙˆØ¹</th>
                    <th style="width:140px;">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                  </tr>
                </thead>
                <tbody>
                  {% for i in range(8) %}
                  <tr>
                    <td>
                      <input class="form-control form-control-sm" name="input_type"
                             value="{{ inputs[i].input_type if i < inputs|length else '' }}">
                    </td>
                    <td>
                      <input type="number" step="0.01"
                             class="form-control form-control-sm input-amount"
                             name="input_amount"
                             value="{{ inputs[i].amount if i < inputs|length else '' }}">
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

          <!-- General Expenses -->
          <div class="col-12 col-lg-4">
            <h5 class="mt-3">Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ø¢Ø¬Ù„Ø© ÙˆØ³Ø¯Ø§Ø¯Ù‡Ø§</h5>
            <div class="table-responsive">
              <table class="table table-sm align-middle text-center">
                <thead>
                  <tr>
                    <th>Ø§Ù„Ù†ÙˆØ¹</th>
                    <th style="width:140px;">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                  </tr>
                </thead>
                <tbody>
                  {% for i in range(8) %}
                  <tr>
                    <td>
                      <input class="form-control form-control-sm" name="gen_type"
                             value="{{ gen[i].expense_type if i < gen|length else '' }}">
                    </td>
                    <td>
                      <input type="number" step="0.01"
                             class="form-control form-control-sm gen-amount"
                             name="gen_amount"
                             value="{{ gen[i].amount if i < gen|length else '' }}">
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

          <!-- Petty Expenses -->
          <div class="col-12 col-lg-4">
            <h5 class="mt-3">Ù…ØµØ±ÙˆÙØ§Øª Ù†Ø«Ø±ÙŠØ©</h5>
            <div class="table-responsive">
              <table class="table table-sm align-middle text-center">
                <thead>
                  <tr>
                    <th>Ø§Ù„Ù†ÙˆØ¹</th>
                    <th style="width:140px;">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                  </tr>
                </thead>
                <tbody>
                  {% for i in range(8) %}
                  <tr>
                    <td>
                      <input class="form-control form-control-sm" name="petty_type"
                             value="{{ petty[i].expense_type if i < petty|length else '' }}">
                    </td>
                    <td>
                      <input type="number" step="0.01"
                             class="form-control form-control-sm petty-amount"
                             name="petty_amount"
                             value="{{ petty[i].amount if i < petty|length else '' }}">
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

        </div>
<!-- Totals Row 1 -->
<div class="row g-3 mt-3">

  <div class="col-12 col-md-3">
    <div class="p-3 bg-light rounded totals-card">
      <div class="small text-muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØµÙ†Ø¯ÙˆÙ‚ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ÙŠÙˆÙ…</div>
      <div class="fs-5 fw-bold" id="total-cash-start">
        {{ '%.2f'|format(totals.cash_start) }}
      </div>
    </div>
  </div>

  <div class="col-12 col-md-3">
    <div class="p-3 bg-light rounded totals-card">
      <div class="small text-muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØµÙ†Ø¯ÙˆÙ‚ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙŠÙˆÙ…</div>
      <div class="fs-5 fw-bold" id="total-cash-end">
        {{ '%.2f'|format(totals.cash_end) }}
      </div>
    </div>
  </div>

  <div class="col-12 col-md-3">
    <div class="p-3 bg-light rounded totals-card">
      <div class="small text-muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ø´Ø¨ÙƒØ© mada</div>
      <div class="fs-5 fw-bold" id="total-mada">
        {{ '%.2f'|format(totals.mada) }}
      </div>
    </div>
  </div>

  <div class="col-12 col-md-3">
    <div class="p-3 bg-light rounded totals-card">
      <div class="small text-muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©</div>
      <div class="fs-5 fw-bold" id="total-inputs">
        {{ '%.2f'|format(totals.inputs) }}
      </div>
    </div>
  </div>

</div>

<!-- Totals Row 2 -->
<div class="row g-3 mt-3">

  <div class="col-12 col-md-3">
    <div class="p-3 bg-light rounded totals-card">
      <div class="small text-muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ø¢Ø¬Ù„Ø© ÙˆØ³Ø¯Ø§Ø¯Ù‡Ø§</div>
      <div class="fs-5 fw-bold" id="total-general">
        {{ '%.2f'|format(totals.general) }}
      </div>
    </div>
  </div>

  <div class="col-12 col-md-3">
    <div class="p-3 bg-light rounded totals-card">
      <div class="small text-muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù†Ø«Ø±ÙŠØ©</div>
      <div class="fs-5 fw-bold" id="total-petty">
        {{ '%.2f'|format(totals.petty) }}
      </div>
    </div>
  </div>

  <div class="col-12 col-md-3">
    <div class="p-3 bg-light rounded totals-card">
      <div class="small text-muted">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ</div>
      <div class="fs-5 fw-bold" id="total-overall">
        {{ '%.2f'|format(totals.total_overall) }}
      </div>
    </div>
  </div>

<div class="col-12 col-md-3"> <div class="p-3 bg-light rounded totals-card"> <div class="small text-muted">Ø§Ù„Ø®Ø·Ø§Ø¡</div> <div class="fs-5 fw-bold text-danger" id="total-error"> {{ '%.2f'|format(totals.error) }}
      </div>
    </div>
  </div>

</div>

</div>
        <!-- Save -->
        <div class="row g-2 mt-3">
          <div class="col-12 col-md-3 ms-md-auto">
            <button type="submit" class="btn btn-primary w-100" name="action" value="save">Ø­ÙØ¸</button>
          </div>
        </div>

        <!-- Notes -->
        <div class="mt-3">
          <label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <textarea class="form-control" name="notes" rows="2"
            placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙŠÙˆÙ…...">{{ header.notes if header and header.notes else '' }}</textarea>
        </div>

      </form>
    </div>
  </div>
</div>

<script>
function toFloat(v){
  const s = (v ?? "").toString().trim();
  if(!s) return 0;
  const n = parseFloat(s.replace(/,/g,''));
  return isNaN(n) ? 0 : n;
}
function sumBy(sel){
  let t = 0;
  document.querySelectorAll(sel).forEach(el => {
    t += toFloat(el.value);
  });
  return t;
}
function setText(id, val){
  const el = document.getElementById(id);
  if(el) el.textContent = Number(val).toFixed(2);
}

function setErrorStyle(val){
  const el = document.getElementById('total-error');
  if(!el) return;
  el.classList.remove('text-success','text-danger');
  el.classList.add(Math.abs(val) < 0.005 ? 'text-success' : 'text-danger');
}

function recalcTotals(){
  const inputs  = sumBy('.input-amount');   // Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©
  const general = sumBy('.gen-amount');     // Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ø¢Ø¬Ù„Ø© ÙˆØ³Ø¯Ø§Ø¯Ù‡Ø§
  const petty   = sumBy('.petty-amount');   // Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù†Ø«Ø±ÙŠØ©

  const cashStart = toFloat(document.querySelector('.cash-start')?.value);
  const cashEnd   = toFloat(document.querySelector('.cash-end')?.value);
  const mada      = toFloat(document.querySelector('.mada')?.value); // âœ… Ø¬Ø¯ÙŠØ¯
  const inEnjaz   = toFloat(document.querySelector('.total-in-enjaz')?.value);

  // âœ… Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ
  const totalOverall = (cashEnd + mada + inputs + general + petty) - cashStart;
  const error = totalOverall - inEnjaz;

  setText('total-inputs', inputs);
  setText('total-general', general);
  setText('total-petty', petty);

  setText('total-cash-start', cashStart);
  setText('total-cash-end', cashEnd);
  setText('total-mada', mada);              // âœ… Ø¬Ø¯ÙŠØ¯

  setText('total-overall', totalOverall);
  setText('total-error', error);
  setErrorStyle(error);
}

document.addEventListener('input', (e) => {
  if (e.target.matches('.input-amount,.gen-amount,.petty-amount,.cash-start,.cash-end,.mada,.total-in-enjaz')) {
    recalcTotals();
  }
});

window.addEventListener('load', recalcTotals);
</script>

{% endblock %}
